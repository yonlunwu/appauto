pipeline {
    agent { label 'slave-1' }

    options {
        timeout(time: "${timeoutHours}", unit: 'HOURS')
    }

    // å®šä¹‰å…¨å±€å˜é‡ï¼Œç”¨äºè®°å½• Deploy é˜¶æ®µçš„æ‰§è¡ŒçŠ¶æ€
    environment {
        DEPLOY_SUCCESS = 'false'  // åˆå§‹åŒ–ä¸ºå¤±è´¥çŠ¶æ€
    }

    stages {
        stage('Download Source Code') {
            steps {
                dir('./appauto') {
                    sh "git checkout ${git_branch} && git pull"
                    sh 'pip install --upgrade pip'
                    sh 'pip install -e . --break-system-packages -i https://pypi.tuna.tsinghua.edu.cn/simple'
                }
            }
        }

        stage('Deploy AMaaS') {
            steps {
                dir('./appauto') {
                    // æ‰§è¡Œéƒ¨ç½²å‘½ä»¤ï¼Œéƒ¨ç½²æˆåŠŸåå°† DEPLOY_SUCCESS è®¾ä¸º true
                    sh "appauto env deploy amaas --user '${user}' --ip ${ip} --ssh-user ${ssh_user} --ssh-port ${ssh_port} --tag ${amaas_tag} --tar-name ${tar_name}"
                    script {
                        // åªæœ‰éƒ¨ç½²å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼ˆé€€å‡ºç  0ï¼‰ï¼Œæ‰ä¼šèµ°åˆ°è¿™é‡Œï¼Œæ›´æ–°çŠ¶æ€
                        env.DEPLOY_SUCCESS = 'true'
                        echo "âœ… Deploy AMaaS é˜¶æ®µæ‰§è¡ŒæˆåŠŸï¼Œæ ‡è®° DEPLOY_SUCCESS = ${env.DEPLOY_SUCCESS}"
                    }
                }
            }
            post {
                failure {
                    echo "âŒ Deploy AMaaS é˜¶æ®µæ‰§è¡Œå¤±è´¥ï¼Œå°†è·³è¿‡ Run Test é˜¶æ®µ"
                }
            }
        }

        stage("Run Test") {
            // æ·»åŠ  when æ¡ä»¶ï¼Œåªæœ‰ DEPLOY_SUCCESS ä¸º true æ—¶æ‰æ‰§è¡Œè¯¥é˜¶æ®µ
            when {
                expression { env.DEPLOY_SUCCESS == 'true' }
            }
            steps {
                script {
                    def buildNumber = env.BUILD_NUMBER
                    def job_name_list = env.JOB_NAME.split('/')
                    echo "job_name_list: ${job_name_list}"
                    echo "buildNumber: ${buildNumber}"

                    dir('./appauto') {
                        sh "appauto run pytest --lark-user '${user}' --topic '${topic}' --testpaths testcases/sanity_check/amaas/test_amaas.py --amaas_ip=${ip} --case-level amaas_ci_sanity_check --model_priority=${model_priority} --ssh_user=${ssh_user} --ssh_port=${ssh_port} --notify-group oc_e005f4612602e5af93d6272c0e8a1355 --report-server=192.168.110.11:9080 --report-url=job/${env.JOB_NAME}/${buildNumber}/allure/"
                    }
                }
            }
        }
    }

    post {
        always {
            dir('./appauto') {
                script {
                    echo "ğŸ” Parsing allure results directory from pytest.ini"
                    def allureResultsDir = sh(
                        script: "grep -Po '(?<=alluredir=)[^\\s]+' pytest.ini || echo 'reports/allure-results'",
                        returnStdout: true
                    ).trim()

                    echo "âœ… Detected Allure Results Dir: ${allureResultsDir}"

                    // Optional: ensure dir exists
                    def exists = sh(
                        script: "test -d ${allureResultsDir} && echo true || echo false",
                        returnStdout: true
                    ).trim()

                    if (exists == "true") {
                        echo "ğŸ“ Allure results directory exists, generating report..."
                        allure([
                            includeProperties: false,
                            jdk: '',
                            reportBuildPolicy: 'ALWAYS',
                            results: [[path: allureResultsDir]]
                        ])
                    } else {
                        echo "âš ï¸ Warning: Allure results directory not found: ${allureResultsDir}"
                    }
                }
            }
        }
    }
}