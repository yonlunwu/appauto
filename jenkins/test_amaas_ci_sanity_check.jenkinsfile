pipeline {
    agent { label 'slave-1' }

    parameters {
        // 1. ã€æ–°å¢å‚æ•°ã€‘æ§åˆ¶æ˜¯å¦æ›´æ–°ä¾èµ–
        booleanParam(name: 'UPDATE_DEPENDENCIES', defaultValue: false, description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°é¡¹ç›®çš„ Python ä¾èµ– (pip install -e .)')
        // 2. ã€æ–°å¢å‚æ•°ã€‘æ§åˆ¶æ˜¯å¦æ‰§è¡Œ Deploy AMaaS é˜¶æ®µ
        booleanParam(name: 'DEPLOY_AMAAS', defaultValue: true, description: 'æ˜¯å¦æ‰§è¡Œ AMaaS æœåŠ¡çš„éƒ¨ç½²æ“ä½œ (appauto env deploy amaas)')
        // å‡è®¾å…¶ä»–å‚æ•° (timeoutHours, git_branch, user, ip, ssh_user, ssh_port, amaas_tag, tar_name, topic, model_priority) å·²å­˜åœ¨
    }

    options {
        timeout(time: "${timeoutHours}", unit: 'HOURS')
    }

    // ä½¿ç”¨ environment å—æ¥å®šä¹‰è·¨é˜¶æ®µå˜é‡ã€‚
    environment {
        // DEPLOY_STATUS é»˜è®¤è®¾ç½®ä¸º '0' (æˆåŠŸ)ã€‚
        // å¦‚æœ DEPLOY_AMAAS=falseï¼Œåˆ™è¯¥å€¼ä¿æŒ '0'ï¼ŒRun Test é˜¶æ®µä¼šè¿è¡Œã€‚
        AMAAS_DEPLOY_STATUS = '0' 
    }

    stages {

        stage('Download Source Code & Install Basic Dependencies') {
            steps {
                sh """
                    cd ./appauto
                    git checkout ${git_branch} && git pull
                    # ä¿æŒåŸºç¡€ä¾èµ–å®‰è£…ï¼Œä½†å°†é¡¹ç›®ä¾èµ–å®‰è£…ç§»è‡³å•ç‹¬çš„ when é˜¶æ®µ
                """
            }
        }
        
        // ã€æ–°å¢é˜¶æ®µã€‘æ ¹æ®å‚æ•°æ§åˆ¶æ˜¯å¦å®‰è£…/æ›´æ–°é¡¹ç›®ä¾èµ–
        stage('Install Project Dependencies') {
            when {
                expression { params.UPDATE_DEPENDENCIES == true } // ä»…å½“ UPDATE_DEPENDENCIES ä¸º true æ—¶æ‰§è¡Œ
            }
            steps {
                echo "â¬‡ï¸ ä¾èµ–æ›´æ–°å‚æ•°ä¸º trueï¼Œå¼€å§‹å®‰è£…/æ›´æ–°é¡¹ç›®ä¾èµ–..."
                sh """
                    cd ./appauto
                    pip install --upgrade pip
                    # ä»…åœ¨ UPDATE_DEPENDENCIES ä¸º true æ—¶ï¼Œé‡æ–°å®‰è£…é¡¹ç›®ä¾èµ–
                    pip install -e . --break-system-packages -i https://pypi.tuna.tsinghua.edu.cn/simple
                """
            }
        }
        
        // ã€æ³¨æ„ã€‘åŸ Download é˜¶æ®µä¸­çš„ `pip install -e .` å·²è¢«ç§»é™¤ï¼Œå¹¶æ”¾åœ¨ Install Project Dependencies é˜¶æ®µï¼Œ
        // é™¤é UPDATE_DEPENDENCIES ä¸º trueï¼Œå¦åˆ™è¯¥é¡¹ç›®ä¾èµ–å®‰è£…æ­¥éª¤ä¼šè¢«è·³è¿‡ã€‚
        // ä¸ºäº†ç¡®ä¿æµæ°´çº¿åœ¨ä¾èµ–è¢«è·³è¿‡æ—¶ä¹Ÿèƒ½è¿è¡Œï¼Œæ‚¨å¯èƒ½éœ€è¦ç¡®ä¿ slave ç¯å¢ƒæˆ–ä¹‹å‰çš„é˜¶æ®µå·²ç»æ»¡è¶³åŸºç¡€ä¾èµ–è¦æ±‚ã€‚

        stage('Deploy AMaaS') {
            // ã€ä¿®æ”¹ã€‘ä»…å½“ DEPLOY_AMAAS å‚æ•°ä¸º true æ—¶æ‰§è¡Œæ­¤é˜¶æ®µ
            when {
                expression { params.DEPLOY_AMAAS == true }
            }
            steps {
                script {
                    echo "ğŸš€ Starting Deploy AMaaS..."

                    // è¿è¡Œéƒ¨ç½²å‘½ä»¤ï¼Œæ•è·çŠ¶æ€ç 
                    def status = sh(
                        script: """
                            cd ./appauto
                            appauto env deploy amaas \
                                --user '${user}' \
                                --ip ${ip} \
                                --ssh-user ${ssh_user} \
                                --ssh-port ${ssh_port} \
                                --tag ${amaas_tag} \
                                --tar-name ${tar_name}
                        """,
                        returnStatus: true
                    )
                    
                    // ã€å…³é”®ä¿®æ”¹ã€‘æ›´æ–° environment å˜é‡ AMAAS_DEPLOY_STATUS
                    env.AMAAS_DEPLOY_STATUS = "${status}"

                    echo "ğŸ“Œ Deploy exit code = ${env.AMAAS_DEPLOY_STATUS}"
                }
            }
        }

        stage('Run Test') {
            when {
                // ã€ä¿®æ”¹ã€‘ä½¿ç”¨ environment å˜é‡ AMAAS_DEPLOY_STATUS æ¥åˆ¤æ–­æ˜¯å¦ç»§ç»­æ‰§è¡Œ
                expression { env.AMAAS_DEPLOY_STATUS == '0' }
            }
            steps {
                script {
                    if (params.DEPLOY_AMAAS == true) {
                        echo "ğŸ¯ Deploy success (Status: ${env.AMAAS_DEPLOY_STATUS}) â†’ Running test stage"
                    } else {
                        echo "ğŸ¯ Deploy skipped (Status: ${env.AMAAS_DEPLOY_STATUS}), proceeding to test stage"
                    }
                    
                    sh """
                        cd ./appauto
                        sleep 180
                        appauto run pytest \
                            --lark-user '${user}' \
                            --topic '${topic}' \
                            --testpaths testcases/sanity_check/amaas/test_amaas.py \
                            --ip=${ip} \
                            --case-level amaas_ci_sanity_check \
                            --model_priority=${model_priority} \
                            --ssh_user=${ssh_user} \
                            --ssh_port=${ssh_port} \
                            --notify-group oc_e005f4612602e5af93d6272c0e8a1355 \
                            --report-server=192.168.110.11:9080 \
                            --report-url=job/${env.JOB_NAME}/${env.BUILD_NUMBER}/allure/
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ğŸ“¦ Generating Allure Report..."

                def allureResultsDir = sh(
                    script: """
                        cd ./appauto
                        grep -Po '(?<=alluredir=)[^\\s]+' pytest.ini || echo 'reports/allure-results'
                    """,
                    returnStdout: true
                ).trim()

                echo "ğŸ“ Allure Results Dir Detected: ${allureResultsDir}"

                def exists = sh(
                    script: "test -d ./appauto/${allureResultsDir} && echo true || echo false",
                    returnStdout: true
                ).trim()

                if (exists == "true") {
                    echo "ğŸ§ª Allure directory exists â†’ generating..."

                    allure([
                        includeProperties: false,
                        jdk: '',
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: "appauto/${allureResultsDir}"]]
                    ])
                } else {
                    echo "âš ï¸ No allure results found at: appauto/${allureResultsDir}"
                }
            }
        }
    }
}
