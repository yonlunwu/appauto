pipeline {
    agent { label 'slave-1' }

    options {
        timeout(time: "${timeoutHours}", unit: 'HOURS')
    }

    stages {

        stage('Download Source Code') {
            steps {
                sh """
                    cd ./appauto
                    git checkout ${git_branch} && git pull
                    pip install --upgrade pip
                    pip install -e . --break-system-packages -i https://pypi.tuna.tsinghua.edu.cn/simple
                """
            }
        }

        stage('Deploy AMaaS') {
            steps {
                script {
                    echo "ðŸš€ Starting Deploy AMaaS..."

                    deploy_status = sh(
                        script: """
                            cd ./appauto
                            appauto env deploy amaas \
                                --user '${user}' \
                                --ip ${ip} \
                                --ssh-user ${ssh_user} \
                                --ssh-port ${ssh_port} \
                                --tag ${amaas_tag} \
                                --tar-name ${tar_name}
                        """,
                        returnStatus: true
                    )

                    echo "ðŸ“Œ Deploy exit code = ${deploy_status}"
                }
            }
        }

        stage('Run Test') {
            when {
                expression { deploy_status == 0 }
            }
            steps {
                script {
                    echo "ðŸŽ¯ Deploy success â†’ Running test stage"

                    sh """
                        cd ./appauto
                        sleep 180
                        appauto run pytest \
                            --lark-user '${user}' \
                            --topic '${topic}' \
                            --testpaths testcases/sanity_check/amaas/test_amaas.py \
                            --ip=${ip} \
                            --case-level amaas_ci_sanity_check \
                            --model_priority=${model_priority} \
                            --ssh_user=${ssh_user} \
                            --ssh_port=${ssh_port} \
                            --notify-group oc_e005f4612602e5af93d6272c0e8a1355 \
                            --report-server=192.168.110.11:9080 \
                            --report-url=job/${env.JOB_NAME}/${env.BUILD_NUMBER}/allure/
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ðŸ“¦ Generating Allure Report..."

                def allureResultsDir = sh(
                    script: """
                        cd ./appauto
                        grep -Po '(?<=alluredir=)[^\\s]+' pytest.ini || echo 'reports/allure-results'
                    """,
                    returnStdout: true
                ).trim()

                echo "ðŸ“ Allure Results Dir Detected: ${allureResultsDir}"

                // check dir exists
                def exists = sh(
                    script: "test -d ./appauto/${allureResultsDir} && echo true || echo false",
                    returnStdout: true
                ).trim()

                if (exists == "true") {
                    echo "ðŸ§ª Allure directory exists â†’ generating..."

                    allure([
                        includeProperties: false,
                        jdk: '',
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: "appauto/${allureResultsDir}"]]
                    ])
                } else {
                    echo "âš ï¸ No allure results found at: appauto/${allureResultsDir}"
                }
            }
        }
    }
}
