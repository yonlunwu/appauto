pipeline {
    agent { label 'slave-1' }

    parameters {
        // æ·»åŠ ä¸€ä¸ª Boolean å‚æ•°æ¥æ§åˆ¶æ˜¯å¦æ›´æ–°ä¾èµ–
        booleanParam(name: 'UPDATE_DEPENDENCIES', defaultValue: false, description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°é¡¹ç›®çš„ Python ä¾èµ– (pip install -e .)')
        // ã€æ–°å¢å‚æ•°ã€‘æ§åˆ¶æ˜¯å¦æ‰§è¡Œ Deploy FT é˜¶æ®µ
        booleanParam(name: 'DEPLOY_FT', defaultValue: true, description: 'æ˜¯å¦æ‰§è¡Œ FT æœåŠ¡çš„éƒ¨ç½²æ“ä½œ (appauto env deploy ft)')
        // å‡è®¾å…¶ä»–å‚æ•° (timeoutHours, git_branch, user, ip, ssh_user, ssh_port, zhiwen_ft_tag, tar_name, topic, ft_port, model_priority, need_empty_gpu_count) å·²åœ¨å…¶ä»–åœ°æ–¹å®šä¹‰æˆ–ä½œä¸ºå­—ç¬¦ä¸²å‚æ•°å­˜åœ¨
    }

    options {
        timeout(time: "${timeoutHours}", unit: 'HOURS')
    }
    
    // ã€ä¿®å¤ BUGã€‘ä½¿ç”¨ environment å—æ¥å®šä¹‰è·¨é˜¶æ®µå˜é‡ã€‚
    // åœ¨ Declarative Pipeline ä¸­ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„è·¨é˜¶æ®µå…±äº«ä¿¡æ¯çš„æ–¹å¼ã€‚
    environment {
        // DEPLOY_STATUS é»˜è®¤è®¾ç½®ä¸º '0' (æˆåŠŸ)ï¼Œç”¨äº Run Test é˜¶æ®µçš„ when åˆ¤æ–­ã€‚
        // å¦‚æœè·³è¿‡ Deploy FTï¼Œåˆ™ä¿ç•™ '0'ï¼Œæµ‹è¯•é˜¶æ®µä¼šè¿è¡Œã€‚
        DEPLOY_STATUS = '0'
    }

    stages {

        stage('Download Source Code') {
            steps {
                sh """
                    cd ./appauto
                    git checkout ${git_branch} && git pull
                """
            }
        }
        
        stage('Install Dependencies') {
            when {
                expression { params.UPDATE_DEPENDENCIES == true } 
            }
            steps {
                echo "â¬‡ï¸ ä¾èµ–æ›´æ–°å‚æ•°ä¸º trueï¼Œå¼€å§‹å®‰è£…/æ›´æ–°ä¾èµ–..."
                sh """
                    cd ./appauto
                    pip install --upgrade pip 
                    pip install -e . --break-system-packages -i https://pypi.tuna.tsinghua.edu.cn/simple
                """
            }
        }

        stage('Deploy FT') {
            when {
                expression { params.DEPLOY_FT == true }
            }
            steps {
                script {
                    echo "ğŸš€ Starting Deploy FT..."

                    // è¿è¡Œéƒ¨ç½²å‘½ä»¤ï¼Œå°†ç»“æœçŠ¶æ€ç è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶ä¿å­˜åˆ° environment å˜é‡ä¸­
                    def status = sh(
                        script: """
                            cd ./appauto
                            appauto env deploy ft \
                                --user '${user}' \
                                --ip ${ip} \
                                --ssh-user ${ssh_user} \
                                --ssh-port ${ssh_port} \
                                --tag ${zhiwen_ft_tag} \
                                --tar-name ${tar_name}
                            sleep 180
                        """,
                        returnStatus: true
                    )
                    
                    // ã€å…³é”®ä¿®æ”¹ã€‘æ›´æ–° environment å˜é‡ DEPLOY_STATUS
                    env.DEPLOY_STATUS = "${status}"

                    echo "ğŸ“Œ Deploy exit code = ${env.DEPLOY_STATUS}"
                }
            }
        }

        stage('Run Test') {
            when {
                // ã€å…³é”®ä¿®æ”¹ã€‘åœ¨ when è¡¨è¾¾å¼ä¸­ç›´æ¥ä½¿ç”¨ environment å˜é‡
                expression { env.DEPLOY_STATUS == '0' }
            }
            steps {
                script {
                    if (params.DEPLOY_FT == true) {
                        echo "ğŸ¯ Deploy success (Status: ${env.DEPLOY_STATUS}) â†’ Running test stage"
                    } else {
                        echo "ğŸ¯ Deploy skipped (Status: ${env.DEPLOY_STATUS}), proceeding to test stage"
                    }

                    sh """
                        cd ./appauto
                        appauto run pytest \
                            --lark-user '${user}' \
                            --topic '${topic}' \
                            --testpaths testcases/sanity_check/ft/test_ft.py \
                            --ip=${ip} \
                            --ft_port=${ft_port} \
                            --case-level ft_ci_sanity_check \
                            --model_priority=${model_priority} \
                            --ssh_user=${ssh_user} \
                            --ssh_port=${ssh_port} \
                            --need_empty_gpu_count=${need_empty_gpu_count} \
                            --tp=${tp} \
                            --notify-group oc_6904399bb84c27191bfa1d7ce0c91066 \
                            --report-server=192.168.110.11:9080 \
                            --report-url=job/${env.JOB_NAME}/${env.BUILD_NUMBER}/allure/
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ğŸ“¦ Generating Allure Report..."

                def allureResultsDir = sh(
                    script: """
                        cd ./appauto
                        grep -Po '(?<=alluredir=)[^\\s]+' pytest.ini || echo 'reports/allure-results'
                    """,
                    returnStdout: true
                ).trim()

                echo "ğŸ“ Allure Results Dir Detected: ${allureResultsDir}"

                def exists = sh(
                    script: "test -d ./appauto/${allureResultsDir} && echo true || echo false",
                    returnStdout: true
                ).trim()

                if (exists == "true") {
                    echo "ğŸ§ª Allure directory exists â†’ generating..."

                    allure([
                        includeProperties: false,
                        jdk: '',
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: "appauto/${allureResultsDir}"]]
                    ])
                } else {
                    echo "âš ï¸ No allure results found at: appauto/${allureResultsDir}"
                }
            }
        }
    }
}
