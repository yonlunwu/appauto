pipeline {
    agent { label 'slave-1' }

    parameters {
        // æ·»åŠ ä¸€ä¸ª Boolean å‚æ•°æ¥æ§åˆ¶æ˜¯å¦æ›´æ–°ä¾èµ–
        booleanParam(name: 'UPDATE_DEPENDENCIES', defaultValue: false, description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°é¡¹ç›®çš„ Python ä¾èµ– (pip install -e .)')
        // å‡è®¾å…¶ä»–å‚æ•° (timeoutHours, git_branch, user, ip, ssh_user, ssh_port, zhiwen_ft_tag, tar_name, topic, ft_port, model_priority) å·²åœ¨å…¶ä»–åœ°æ–¹å®šä¹‰æˆ–ä½œä¸ºå­—ç¬¦ä¸²å‚æ•°å­˜åœ¨
    }

    options {
        timeout(time: "${timeoutHours}", unit: 'HOURS')
    }

    stages {

        stage('Download Source Code') {
            steps {
                sh """
                    cd ./appauto
                    git checkout ${git_branch} && git pull
                """
            }
        }
        
        // æ–°å¢ä¸€ä¸ªä¾èµ–å®‰è£…é˜¶æ®µï¼Œå¹¶ä½¿ç”¨ when æ£€æŸ¥å‚æ•°
        stage('Install Dependencies') {
            when {
                expression { params.UPDATE_DEPENDENCIES == true } // ä»…å½“ UPDATE_DEPENDENCIES ä¸º true æ—¶æ‰§è¡Œ
            }
            steps {
                echo "â¬‡ï¸ ä¾èµ–æ›´æ–°å‚æ•°ä¸º trueï¼Œå¼€å§‹å®‰è£…/æ›´æ–°ä¾èµ–..."
                sh """
                    cd ./appauto
                    pip install --upgrade pip 
                    # ä»…åœ¨ UPDATE_DEPENDENCIES ä¸º true æ—¶ï¼Œé‡æ–°å®‰è£…é¡¹ç›®ä¾èµ–
                    pip install -e . --break-system-packages -i https://pypi.tuna.tsinghua.edu.cn/simple
                """
            }
        }

        stage('Deploy FT') {
            steps {
                script {
                    echo "ğŸš€ Starting Deploy FT..."

                    deploy_status = sh(
                        script: """
                            cd ./appauto
                            appauto env deploy ft \
                                --user '${user}' \
                                --ip ${ip} \
                                --ssh-user ${ssh_user} \
                                --ssh-port ${ssh_port} \
                                --tag ${zhiwen_ft_tag} \
                                --tar-name ${tar_name} \
                        """,
                        returnStatus: true
                    )

                    echo "ğŸ“Œ Deploy exit code = ${deploy_status}"
                }
            }
        }

        stage('Run Test') {
            when {
                expression { deploy_status == 0 }
            }
            steps {
                script {
                    echo "ğŸ¯ Deploy success â†’ Running test stage"

                    sh """
                        cd ./appauto
                        sleep 180
                        appauto run pytest \
                            --lark-user '${user}' \
                            --topic '${topic}' \
                            --testpaths testcases/sanity_check/ft/test_ft.py \
                            --ip=${ip} \
                            --ft_port=${ft_port} \
                            --case-level ft_ci_sanity_check \
                            --model_priority=${model_priority} \
                            --ssh_user=${ssh_user} \
                            --ssh_port=${ssh_port} \
                            --need_empty_gpu_count=${need_empty_gpu_count} \
                            --notify-group oc_6904399bb84c27191bfa1d7ce0c91066 \
                            --report-server=192.168.110.11:9080 \
                            --report-url=job/${env.JOB_NAME}/${env.BUILD_NUMBER}/allure/
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ğŸ“¦ Generating Allure Report..."

                def allureResultsDir = sh(
                    script: """
                        cd ./appauto
                        grep -Po '(?<=alluredir=)[^\\s]+' pytest.ini || echo 'reports/allure-results'
                    """,
                    returnStdout: true
                ).trim()

                echo "ğŸ“ Allure Results Dir Detected: ${allureResultsDir}"

                // check dir exists
                def exists = sh(
                    script: "test -d ./appauto/${allureResultsDir} && echo true || echo false",
                    returnStdout: true
                ).trim()

                if (exists == "true") {
                    echo "ğŸ§ª Allure directory exists â†’ generating..."

                    allure([
                        includeProperties: false,
                        jdk: '',
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: "appauto/${allureResultsDir}"]]
                    ])
                } else {
                    echo "âš ï¸ No allure results found at: appauto/${allureResultsDir}"
                }
            }
        }
    }
}
